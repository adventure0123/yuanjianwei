---
title: redis_transation
date: 2016-11-12 23:53:38
tags: [redis,redis transaction]
---
&emsp;&emsp;redis通过multi，exec,watch等命令来实现事务功能。<!--more-->事务提供了一种将命令请求打包，然后一次性按照顺序的执行，执行的过程中不会插入其他的命令。并且在事务的执行过程中，服务器不会中断事务去执行其他的客户端请求。
&emsp;&emsp;redis的事务从开始到结束通常会经历以下三个过程：1，事务开始。2，命令入队。3，事务执行。以下是一个事务的执行过程，该事务首先以一个multi命令开始，接着将多个命令放入事务中。最后由exec命令将这个事务提交给服务器执行。
```vim
127.0.0.1:6379>multi
OK
127.0.0.1:6379>set redis transaction
QUEUED
127.0.0.1:6379>exec
OK
```
redis的事务和传统的关系型数据库事务最大的区别在于，redis不支持事务的回滚机制。即使事务队列中的某个命令在执行期间出现了错误，整个事务也会执行下去，直到将事务中的所有命令都执行完毕为止。如果一个事务在入队的过程中，出现命令不存在，或者命令的格式不正确等情况，那么redis将会拒绝执行这个事务。
```vim
127.0.0.1:6379> multi
OK
127.0.0.1:6379> in redis
(error) ERR unknown command 'in'
127.0.0.1:6379> exec
(error) EXECABORT Transaction discarded because of previous errors.
```
除了入队可能发生的错误以外，事务还可能在执行的过程中出现错误。这些错误都是一些不能再入队时被服务器发现的错误，这些错误只会在命令执行时被触发。即使事务在执行的过程中发生了错误，服务器也不会中断事务的执行，它会继续执行事务中余下的命令，并且已经执行的命令不会被出错的命令影响。对数据库的键执行了错误的类型操作是事务执行期间最常见的错误之一。首先我们用set命令把redis设置为hello，然后执行sadd命令，这将会引发错误，并且错误只能在事务执行过程中才能被发现。
```vim
127.0.0.1:6379> set redis hello
OK
127.0.0.1:6379> multi
OK
127.0.0.1:6379> sadd redis test
QUEUED
127.0.0.1:6379> exec
1) (error) WRONGTYPE Operation against a key holding the wrong kind of value
127.0.0.1:6379> 
```

&emsp;&emsp;如果redis服务器在执行过程中停机，那么根据服务器所使用的持久化模式，可能有以下情况的发生：
* 1 如果服务器运行在无持久化的内存模式下，那么重启之后数据库将是空白的。

* 2 如果服务器运行在rdb模式下，那么在事务过程中停机不会导致不一致，因为服务会根据现有的rdb文件来恢复数据，从而将数据库还原到一个一致的状态。如果找不到可供使用的rdb文件，那么重启之后数据将会是空白的

* 3 如果服务器运行在aof模式下，那么事务在中途停机也不会导致不一致。因为服务可以根据现有的aof文件来恢复，从而将数据库还原到一个一致的状态。如果找不到可供使用的aof文件，那么数据库将会是空白的。

综上所述，无论数据库运行在哪种模式下，事务执行过程中的停机都不会影响数据库的一致性。

&emsp;&emsp;从上面的例子中可以看出，数据库运行在事务过程中，只有在事务结束时才返回结果。但如果事务中的命令依赖于上一条的命令该怎么办，例如实现i++。假设两个客户端a,b同时获取到key A的value是1，然后客户端b执行事务A++，客户端执行事务A++，最后得到的结果将会是A=2，而不是正确的结果3。为了解决这个问题redis，提供了watch命令。watch命令是一个乐观锁，他可以在exec命令执行前，监控任意数量的数据库键，并在exec执行时，检查被监控的键是否至少有一个已经被修改过了，如果是的话，将拒绝执行事务，并向客户端返回失败的空回复。例如：
```vim
客户端A监控key：
127.0.0.1:6379> watch redis
OK
客户端B修改key：
127.0.0.1:6379> set redis 2
OK
客户端A执行事务：
127.0.0.1:6379> multi
OK
127.0.0.1:6379> set redis 1
QUEUED
127.0.0.1:6379> exec
(nil)
```
执行exec之后将会取消所有所有watch监控的key